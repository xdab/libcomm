# .clinerules - Technical Rules for libcomm

Networking and IPC utilities library aimed at reducing boilerplate code across simple projects. Provides TCP/UDP networking, Unix Domain Socket IPC, epoll-based polling and buffer utilities.

## Code Style

- **Minimal comments**â€”self-explanatory code preferred
- **Function prefixes** group related functionality: `tcp_`, `udp_`, `uds_`, `socket_`, `buf_`/`fbuf_`, `socket_poller_`
- **Struct-based organization** with `init()`, `process()`, `free()` pattern
- **Buffer safety**: Always pass buffer size, verify available capacity before writes
- **Error codes**: 0 = success, negative = error
- **Goto for cleanup** only in main functions

## Module Breakdown

### Networking

- **`tcp_*`**: TCP client/server with connection management and event callbacks
  - `tcp_server_*`: Listen socket, client array (max 16), connect/disconnect callbacks
  - `tcp_client_*`: Connect to remote, send/receive with timeout

- **`udp_*`**: Connectionless packet I/O
  - `udp_sender_*`: Send to specific destination
  - `udp_server_*`: Bind to port, receive from any source

### IPC

- **`uds_*`**: Unix Domain Sockets for local inter-process communication
  - `uds_server_*` / `uds_client_*`: Stream sockets (connected, reliable)
  - `uds_dgram_*`: Datagram sockets (connectionless, unconnected)

### Core

- **`socket_poller_*`**: epoll-based multi-FD polling for efficient I/O multiplexing
- **`buf_*` / `fbuf_*`**: Buffer capacity/size checks for byte and float buffers
- **`socket_*`**: Low-level socket utilities (nonblocking, bind, select)
- **`common_*`**: Logging macros and utilities

## Logging

Macros in `common.h`, output to stderr, auto-includes function name:

- `LOG(str, ...)`: Always visible
- `LOGV(str, ...)`: With `--verbose`
- `LOGD(str, ...)`: With `--debug` only
- `EXIT(code, str, ...)`, `EXITIF(cond, code, ...)`: Fatal errors
- `nonnull(val, name)`, `nonzero(val, name)`: Input validation (exit -2/-3)

Messages: lowercase start, no period/newline (auto-added).

## Build

**Library**: `libcomm.a` (static)

**Makefile targets**: `build`, `release`, `test`, `install`, `clean`, `echo`

## Unit Testing

- Test files: `test_*.h` (functions matching `void test_name(void)`)
- Added to `main_test.c`
- Run via `make test`
- Use assertion macros from `test.h`
- Test: normal operation, boundary conditions (empty/full/wrap), init/free, diverse inputs

## Using in real projects

Refer to snippets in `README.md` as well as a demo echo server in `src/main_echo.c`.
